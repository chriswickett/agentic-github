name: Run Skill
description: Checkout client repo, setup agent, gather context, and run a Claude skill

inputs:
  skill-name:
    description: 'Name of the skill to run (e.g., gh-respond, pr-start, pr-fix, pr-merge)'
    required: true
  context-type:
    description: 'Type of context to gather: issue or pr'
    required: true
  fetch-depth:
    description: 'Number of commits to fetch. 0 for full history.'
    required: false
    default: '1'

runs:
  using: composite
  steps:
    - name: Block fork PRs
      shell: bash
      run: |
        EVENT=$(cat "$GITHUB_EVENT_PATH")
        if [[ "${{ inputs.context-type }}" == "pr" ]]; then
          HEAD_REPO=$(echo "$EVENT" | jq -r '.pull_request.head.repo.full_name // empty')
          if [[ -z "$HEAD_REPO" ]]; then
            PR_NUMBER=$(echo "$EVENT" | jq -r '.issue.number')
            HEAD_REPO=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json headRepositoryOwner,headRepository -q '"\(.headRepositoryOwner.login)/\(.headRepository.name)"')
          fi
          if [[ -n "$HEAD_REPO" && "$HEAD_REPO" != "${{ github.repository }}" ]]; then
            echo "::error::Refusing to run on fork PR from $HEAD_REPO"
            exit 1
          fi
        fi

    - name: Determine ref
      id: ref
      shell: bash
      run: |
        EVENT=$(cat "$GITHUB_EVENT_PATH")
        if [[ "${{ inputs.context-type }}" == "pr" ]]; then
          REF=$(echo "$EVENT" | jq -r '.pull_request.head.ref // empty')
          if [[ -z "$REF" ]]; then
            PR_NUMBER=$(echo "$EVENT" | jq -r '.issue.number')
            REF=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json headRefName -q .headRefName)
          fi
          echo "ref=$REF" >> $GITHUB_OUTPUT
        else
          echo "ref=" >> $GITHUB_OUTPUT
        fi

    - name: Check out client repo
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.ref.outputs.ref }}
        fetch-depth: ${{ inputs.fetch-depth }}
        path: repo

    - name: Install Claude CLI
      shell: bash
      run: npm install -g @anthropic-ai/claude-code

    - name: Install dependencies
      shell: bash
      working-directory: repo
      run: |
        if [ -f "pnpm-lock.yaml" ]; then
          npm install -g pnpm
          pnpm install --frozen-lockfile
        elif [ -f "package-lock.json" ]; then
          npm ci
        elif [ -f "yarn.lock" ]; then
          npm install -g yarn
          yarn install --frozen-lockfile
        fi

    - name: Setup mkcert for trusted HTTPS
      shell: bash
      run: |
        curl -sSJLO "https://dl.filippo.io/mkcert/latest?for=linux/amd64"
        chmod +x mkcert-v*-linux-amd64
        sudo mv mkcert-v*-linux-amd64 /usr/local/bin/mkcert
        mkcert -install 2>/dev/null
        echo "NODE_EXTRA_CA_CERTS=$(mkcert -CAROOT)/rootCA.pem" >> $GITHUB_ENV

    - name: Install and start headless Chrome
      shell: bash
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq google-chrome-stable 2>/dev/null || sudo apt-get install -y -qq chromium-browser 2>/dev/null
        CHROME_BIN=$(command -v google-chrome || command -v chromium-browser)
        $CHROME_BIN \
          --headless=new \
          --no-sandbox \
          --disable-dev-shm-usage \
          --remote-debugging-port=9222 \
          --remote-debugging-address=0.0.0.0 \
          about:blank 2>/dev/null &

    - name: Configure Chrome DevTools MCP
      shell: bash
      run: |
        echo '{"mcpServers":{"chrome-devtools":{"type":"stdio","command":"npx","args":["chrome-devtools-mcp@latest","--browserUrl=http://localhost:9222"]}}}' > ~/.claude.json

    - name: Apply skill overrides
      shell: bash
      run: $GITHUB_WORKSPACE/bin/apply-skill-overrides

    - name: Gather context
      shell: bash
      run: |
        EVENT=$(cat "$GITHUB_EVENT_PATH")
        NUMBER=$(echo "$EVENT" | jq -r '.issue.number // .pull_request.number')
        SKILLS_DIR="$GITHUB_WORKSPACE"
        if [ "${{ inputs.context-type }}" = "issue" ]; then
          $SKILLS_DIR/bin/gather-issue-context "$NUMBER" "${{ github.repository }}" > /tmp/context.txt
        else
          $SKILLS_DIR/bin/gather-pr-context "$NUMBER" "${{ github.repository }}" > /tmp/context.txt
        fi

    - name: Run Claude with skill
      shell: bash
      working-directory: repo
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ env.CLAUDE_CODE_OAUTH_TOKEN }}
      run: |
        SKILLS_DIR="$GITHUB_WORKSPACE"
        PROMPT=$(SKILLS_DIR="$SKILLS_DIR" SKILL_NAME="${{ inputs.skill-name }}" envsubst < "$SKILLS_DIR/.github/actions/lib/run-skill/prompt.md")
        cat <<CTX_EOF | claude -p --verbose --output-format stream-json --dangerously-skip-permissions | $SKILLS_DIR/bin/parse-claude-json-stream
        $PROMPT

        $(cat /tmp/context.txt)
        CTX_EOF

name: Dispatch
description: Takes github event data and runs the appropriate job

inputs:
  secrets-json:
    description: 'All secrets as JSON'
    required: true
  vars-json:
    description: 'All vars as JSON'
    required: false
    default: '{}'

runs:
  using: composite
  steps:
    - shell: bash
      run: echo "== INJECTING ENVIRONMENT ==============="

    - uses: ./.github/actions/lib/inject-env
      with:
        secrets-json: ${{ inputs.secrets-json }}
        vars-json: ${{ inputs.vars-json }}

    - shell: bash
      run: echo "== ROUTING EVENT ======================="

    - id: route
      shell: bash
      run: |
        JOB=$($GITHUB_WORKSPACE/bin/determine-job-from-event)
        [[ -n "$JOB" ]] && echo "job=$JOB" >> $GITHUB_OUTPUT

    - uses: ./.github/actions/jobs/gh-respond
      if: steps.route.outputs.job == 'gh-respond'

    - uses: ./.github/actions/jobs/pr-start
      if: steps.route.outputs.job == 'pr-start'

    - uses: ./.github/actions/jobs/pr-fix
      if: steps.route.outputs.job == 'pr-fix'

    - uses: ./.github/actions/jobs/pr-merge
      if: steps.route.outputs.job == 'pr-merge'

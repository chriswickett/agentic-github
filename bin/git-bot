#!/usr/bin/env bash
set -euo pipefail

# git-bot: wraps git and gh commands with bot identity.
# Requires AGENTIC_BOT_NAME and AGENTIC_BOT_EMAIL env vars.
# For gh commands, also requires GH_TOKEN.
# If a .env file exists in the script's directory (repo root), it is sourced automatically.

SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
if [[ -f "$SCRIPT_DIR/.env" ]]; then
  set -a
  source "$SCRIPT_DIR/.env"
  set +a
fi

if [[ -z "${AGENTIC_BOT_NAME:-}" || -z "${AGENTIC_BOT_EMAIL:-}" ]]; then
  echo "Error: AGENTIC_BOT_NAME and AGENTIC_BOT_EMAIL must be set." >&2
  exit 1
fi

cmd="${1:-}"
shift || { echo "Usage: git-bot {git|gh} [args...]" >&2; exit 1; }

case "$cmd" in
  git)
    GIT_AUTHOR_NAME="$AGENTIC_BOT_NAME" \
    GIT_AUTHOR_EMAIL="$AGENTIC_BOT_EMAIL" \
    GIT_COMMITTER_NAME="$AGENTIC_BOT_NAME" \
    GIT_COMMITTER_EMAIL="$AGENTIC_BOT_EMAIL" \
    git "$@"
    ;;
  gh)
    if [[ -z "${GH_TOKEN:-}" ]]; then
      echo "Error: GH_TOKEN must be set for gh commands." >&2
      exit 1
    fi
    gh "$@"
    ;;
  *)
    echo "Usage: git-bot {git|gh} [args...]" >&2
    exit 1
    ;;
esac

#!/usr/bin/env bash
set -euo pipefail

EVENT=$(cat "$GITHUB_EVENT_PATH")

route() {
  local body state is_pr

  [[ "$GITHUB_EVENT_NAME" == "issues" ]] && {
    body=$(echo "$EVENT" | jq -r '.issue.body')
    [[ "$body" == @claude* ]] && echo "gh-respond" && return
    return
  }

  [[ "$GITHUB_EVENT_NAME" == "issue_comment" ]] && {
    body=$(echo "$EVENT" | jq -r '.comment.body')
    is_pr=$(echo "$EVENT" | jq -r '.issue.pull_request // empty')
    [[ "$body" == @claude\ /pr-start* && -z "$is_pr" ]] && echo "pr-start" && return
    [[ "$body" == @claude* ]] && echo "gh-respond" && return
    return
  }

  [[ "$GITHUB_EVENT_NAME" == "pull_request_review" ]] && {
    body=$(echo "$EVENT" | jq -r '.review.body')
    [[ "$body" != @claude* ]] && return
    state=$(echo "$EVENT" | jq -r '.review.state')
    [[ "$state" == "changes_requested" ]] && echo "pr-fix" && return
    [[ "$state" == "approved" ]] && echo "pr-merge" && return
  }
}

route

#!/usr/bin/env bash
set -euo pipefail

source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/lib/common.sh"

# Parse flags
while [[ $# -gt 0 ]]; do
  case "$1" in
    --repo)  export FULL_REPO="$2";  shift 2 ;;
    --path)  export CLIENT_DIR="$2"; shift 2 ;;
    -y)      export NONINTERACTIVE=1; shift ;;
    *)       err "Unknown flag: $1" ;;
  esac
done

for cmd in gh git jq; do
  command -v "$cmd" &>/dev/null || err "$cmd is not installed"
done

gh auth status &>/dev/null 2>&1 \
  || err "Not authenticated with GitHub CLI. Run 'gh auth login' first."

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AGENTIC_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
AGENTIC_REMOTE=$(git -C "$AGENTIC_ROOT" remote get-url origin 2>/dev/null) \
  || err "Could not detect agentic repo remote"
AGENTIC_REPO=$(echo "$AGENTIC_REMOTE" | sed -E 's|.*github\.com[:/]||; s|\.git$||')
export SCRIPT_DIR AGENTIC_ROOT AGENTIC_REPO

echo ""
echo -e "${BOLD}Agentic Client Repo Setup${RESET}"
echo -e "${DIM}Agentic repo: $AGENTIC_REPO${RESET}"

"$SCRIPT_DIR/prerequisites"

echo ""

STEPS="$SCRIPT_DIR/steps"
source "$STEPS/repo"
source "$STEPS/settings"
source "$STEPS/workflows"
source "$STEPS/secrets"
source "$STEPS/collaborator"
source "$STEPS/claude-md"
source "$STEPS/commit-push"

echo ""
echo -e "${BOLD}${GREEN}Setup complete!${RESET}"
echo ""
echo "  Repo:      https://github.com/$FULL_REPO"
echo "  Workflows: 4 files in .github/workflows/"
echo ""
echo "Flesh out CLAUDE.md with detailed project context, then verify the setup:"
echo ""
echo "  gh issue create --repo $FULL_REPO \\"
echo "    --title 'Test agentic setup' --body '@claude Are you there?'"

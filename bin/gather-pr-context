#!/usr/bin/env bash
set -euo pipefail

PR_NUMBER="$1"
REPO="$2"

PR_JSON=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json number,title,body,headRefName)
REVIEWS_JSON=$(gh api "repos/$REPO/pulls/$PR_NUMBER/reviews")
COMMENTS_JSON=$(gh api "repos/$REPO/issues/$PR_NUMBER/comments")

LATEST_CHANGES_REQUESTED=$(jq -r '[.[] | select(.state=="CHANGES_REQUESTED")] | last | .body' <<< "$REVIEWS_JSON")

ALL_COMMENTS=$(jq -s '
  [
    (.[0][]? | {ts: .submitted_at, user: .user.login, body: .body}),
    (.[1][]? | {ts: .created_at, user: .user.login, body: .body})
  ] | sort_by(.ts)
' <<< "$REVIEWS_JSON
$COMMENTS_JSON")

{
  echo "PR number: $(jq -r '.number' <<< "$PR_JSON")"
  echo ""
  echo "Title: $(jq -r '.title' <<< "$PR_JSON")"
  echo ""
  echo "Head ref: $(jq -r '.headRefName' <<< "$PR_JSON")"
  echo ""
  echo "PR body: $(jq -r '.body' <<< "$PR_JSON")"
  echo ""
  echo "Current changes_requested review body:"
  echo "--------------------------------------"
  echo "$LATEST_CHANGES_REQUESTED"
  echo ""
  echo "Full review/comment timeline with timestamps:"
  echo "---------------------------------------------"
  jq -r '.[] | "\(.ts) - \(.user): \(.body)"' <<< "$ALL_COMMENTS"
} > /tmp/pr.txt

git log -n 10 --format="%h %s%n%n%b" --name-only origin/main..HEAD > /tmp/commits.txt

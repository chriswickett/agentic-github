#!/usr/bin/env bash
set -euo pipefail
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/../lib/common.sh"

require_vars FULL_REPO

if [[ -n "${NONINTERACTIVE:-}" ]]; then
  warn "Skipping secrets setup (non-interactive mode)"
  warn "Set secrets manually before using the workflows:"
  echo "    gh secret set CLAUDE_CODE_OAUTH_TOKEN --repo $FULL_REPO"
  echo "    gh secret set AGENTIC_BOT_TOKEN --repo $FULL_REPO"
  echo "    gh variable set AGENTIC_BOT_NAME --repo $FULL_REPO --body \"bot-username\""
  echo "    gh variable set AGENTIC_BOT_EMAIL --repo $FULL_REPO --body \"123+bot@users.noreply.github.com\""
  return 0 2>/dev/null || exit 0
fi

echo ""
read -rp "Configure secrets and variables now? [y/N]: " SETUP_SECRETS

if [[ "${SETUP_SECRETS,,}" == "y" ]]; then
  echo ""
  echo -e "${BOLD}Secrets${RESET}"
  echo -e "${DIM}Run 'claude setup-token' to get your CLAUDE_CODE_OAUTH_TOKEN.${RESET}"
  echo -e "${DIM}It authenticates with your Claude Pro/Max subscription and outputs an OAuth token.${RESET}"
  echo ""

  echo -n "CLAUDE_CODE_OAUTH_TOKEN: "
  read -rs CLAUDE_TOKEN
  echo ""
  [[ -n "$CLAUDE_TOKEN" ]] && echo "$CLAUDE_TOKEN" | gh secret set CLAUDE_CODE_OAUTH_TOKEN --repo "$FULL_REPO"

  echo -n "AGENTIC_BOT_TOKEN: "
  read -rs BOT_TOKEN
  echo ""
  [[ -n "$BOT_TOKEN" ]] && echo "$BOT_TOKEN" | gh secret set AGENTIC_BOT_TOKEN --repo "$FULL_REPO"

  echo ""
  echo -e "${BOLD}Variables${RESET}"

  read -rp "AGENTIC_BOT_NAME: " BOT_NAME
  [[ -n "$BOT_NAME" ]] && gh variable set AGENTIC_BOT_NAME --repo "$FULL_REPO" --body "$BOT_NAME"

  read -rp "AGENTIC_BOT_EMAIL: " BOT_EMAIL
  [[ -n "$BOT_EMAIL" ]] && gh variable set AGENTIC_BOT_EMAIL --repo "$FULL_REPO" --body "$BOT_EMAIL"

  ok "Secrets and variables configured"

  export BOT_TOKEN BOT_NAME
else
  echo ""
  warn "Remember to set these before using the workflows:"
  echo -e "  ${DIM}Run 'claude setup-token' to get your CLAUDE_CODE_OAUTH_TOKEN.${RESET}"
  echo ""
  echo "  Secrets:"
  echo "    gh secret set CLAUDE_CODE_OAUTH_TOKEN --repo $FULL_REPO"
  echo "    gh secret set AGENTIC_BOT_TOKEN --repo $FULL_REPO"
  echo ""
  echo "  Variables:"
  echo "    gh variable set AGENTIC_BOT_NAME --repo $FULL_REPO --body \"bot-username\""
  echo "    gh variable set AGENTIC_BOT_EMAIL --repo $FULL_REPO --body \"123+bot@users.noreply.github.com\""
fi

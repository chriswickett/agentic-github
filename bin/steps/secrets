#!/usr/bin/env bash
set -euo pipefail
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/../lib/guards.sh"

require_vars FULL_REPO

print_manual_commands() {
  cat << EOF
  ${DIM}Run 'claude setup-token' to get your CLAUDE_CODE_OAUTH_TOKEN.${RESET}

  Secrets:
    gh secret set CLAUDE_CODE_OAUTH_TOKEN --repo $FULL_REPO
    gh secret set AGENTIC_BOT_TOKEN --repo $FULL_REPO

  Variables:
    gh variable set AGENTIC_BOT_NAME --repo $FULL_REPO --body "bot-username"
    gh variable set AGENTIC_BOT_EMAIL --repo $FULL_REPO --body "123+bot@users.noreply.github.com"
EOF
}

set_secret() {
  echo "$2" | gh secret set "$1" --repo "$FULL_REPO"
  ok "$1 set"
}

set_variable() {
  gh variable set "$1" --repo "$FULL_REPO" --body "$2"
  ok "$1 = $2"
}

derive_bot_identity() {
  [[ -n "${AGENTIC_BOT_NAME:-}" ]] && [[ -n "${AGENTIC_BOT_EMAIL:-}" ]] && return 0
  info "Looking up bot identity from token..."
  local login id
  login=$(GH_TOKEN="$1" gh api /user --jq '.login' 2>/dev/null) \
    || err "Could not look up bot identity — check the token is valid"
  id=$(GH_TOKEN="$1" gh api /user --jq '.id' 2>/dev/null)
  AGENTIC_BOT_NAME="${AGENTIC_BOT_NAME:-$login}"
  AGENTIC_BOT_EMAIL="${AGENTIC_BOT_EMAIL:-${id}+${login}@users.noreply.github.com}"
  ok "AGENTIC_BOT_NAME = $AGENTIC_BOT_NAME"
  ok "AGENTIC_BOT_EMAIL = $AGENTIC_BOT_EMAIL"
}

all_env_set() {
  [[ -n "${CLAUDE_CODE_OAUTH_TOKEN:-}" ]] \
    && [[ -n "${AGENTIC_BOT_TOKEN:-}" ]] \
    && [[ -n "${AGENTIC_BOT_NAME:-}" ]] \
    && [[ -n "${AGENTIC_BOT_EMAIL:-}" ]]
}

apply_from_env() {
  echo ""
  info "Setting secrets and variables from environment..."
  set_secret CLAUDE_CODE_OAUTH_TOKEN "$CLAUDE_CODE_OAUTH_TOKEN"
  set_secret AGENTIC_BOT_TOKEN "$AGENTIC_BOT_TOKEN"
  set_variable AGENTIC_BOT_NAME "$AGENTIC_BOT_NAME"
  set_variable AGENTIC_BOT_EMAIL "$AGENTIC_BOT_EMAIL"
  export BOT_TOKEN="$AGENTIC_BOT_TOKEN" BOT_NAME="$AGENTIC_BOT_NAME"
}

# Derive bot name/email from token if not already set
[[ -n "${AGENTIC_BOT_TOKEN:-}" ]] && derive_bot_identity "$AGENTIC_BOT_TOKEN"

# All 4 values available — set them directly, no prompts
if all_env_set; then
  apply_from_env
  return 0 2>/dev/null || exit 0
fi

# Non-interactive with missing env vars — can't prompt
if [[ -n "${NONINTERACTIVE:-}" ]]; then
  warn "Skipping secrets setup (non-interactive mode)"
  print_manual_commands
  return 0 2>/dev/null || exit 0
fi

echo ""
read -rp "Configure secrets and variables now? [y/N]: " SETUP_SECRETS

if [[ "${SETUP_SECRETS,,}" == "y" ]]; then
  cat << EOF

${BOLD}Secrets${RESET}
${DIM}Run 'claude setup-token' to get your CLAUDE_CODE_OAUTH_TOKEN.
It authenticates with your Claude Pro/Max subscription and outputs an OAuth token.${RESET}

EOF

  if [[ -n "${CLAUDE_CODE_OAUTH_TOKEN:-}" ]]; then
    set_secret CLAUDE_CODE_OAUTH_TOKEN "$CLAUDE_CODE_OAUTH_TOKEN"
  else
    echo -n "CLAUDE_CODE_OAUTH_TOKEN: "
    read -rs CLAUDE_TOKEN
    echo ""
    [[ -n "$CLAUDE_TOKEN" ]] && set_secret CLAUDE_CODE_OAUTH_TOKEN "$CLAUDE_TOKEN"
  fi

  if [[ -n "${AGENTIC_BOT_TOKEN:-}" ]]; then
    set_secret AGENTIC_BOT_TOKEN "$AGENTIC_BOT_TOKEN"
    BOT_TOKEN="$AGENTIC_BOT_TOKEN"
  else
    echo -n "AGENTIC_BOT_TOKEN: "
    read -rs BOT_TOKEN
    echo ""
    [[ -n "$BOT_TOKEN" ]] && set_secret AGENTIC_BOT_TOKEN "$BOT_TOKEN"
  fi

  echo ""
  echo -e "${BOLD}Variables${RESET}"

  # Derive name/email from bot token if available
  [[ -n "${BOT_TOKEN:-}" ]] && derive_bot_identity "$BOT_TOKEN"

  if [[ -n "${AGENTIC_BOT_NAME:-}" ]]; then
    set_variable AGENTIC_BOT_NAME "$AGENTIC_BOT_NAME"
    BOT_NAME="$AGENTIC_BOT_NAME"
  else
    read -rp "AGENTIC_BOT_NAME: " BOT_NAME
    [[ -n "$BOT_NAME" ]] && set_variable AGENTIC_BOT_NAME "$BOT_NAME"
  fi

  if [[ -n "${AGENTIC_BOT_EMAIL:-}" ]]; then
    set_variable AGENTIC_BOT_EMAIL "$AGENTIC_BOT_EMAIL"
  else
    read -rp "AGENTIC_BOT_EMAIL: " BOT_EMAIL
    [[ -n "$BOT_EMAIL" ]] && set_variable AGENTIC_BOT_EMAIL "$BOT_EMAIL"
  fi

  ok "Secrets and variables configured"

  export BOT_TOKEN BOT_NAME
else
  echo ""
  warn "Remember to set these before using the workflows:"
  print_manual_commands
fi
